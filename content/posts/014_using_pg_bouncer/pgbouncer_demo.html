<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>pgBouncer Pooling Visual Demo</title>
        <style>
            /* same styling as before, nothing changed here â€¦ */
            body {
                font-family: Arial, Helvetica, sans-serif;
                margin: 0;
                background: #f0f4f8;
                padding: 1rem;
            }
            h1 {
                text-align: center;
                margin: 0 0 1rem;
            }
            .grid {
                display: flex;
                flex-wrap: wrap;
                gap: 2rem;
                justify-content: center;
            }
            .panel {
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
                padding: 1.2rem;
                flex: 1 1 480px;
                max-width: 520px;
            }
            .panel h2 {
                margin: 0 0 0.4rem;
                text-align: center;
                font-size: 1.3rem;
            }
            label {
                display: block;
                margin-top: 0.4rem;
                font-size: 0.9rem;
            }
            input[type="range"],
            input[type="number"] {
                width: 100%;
            }
            button {
                position: relative;
                overflow: hidden;
                margin-top: 0.6rem;
                padding: 0.55rem 1.1rem;
                font-size: 1rem;
                color: #fff;
                background: #1976d2;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                transition: transform 0.1s;
            }
            button:active {
                transform: scale(0.94);
            }
            button:after {
                content: "";
                position: absolute;
                left: 50%;
                top: 50%;
                width: 0;
                height: 0;
                background: rgba(255, 255, 255, 0.4);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                transition:
                    width 0.4s ease-out,
                    height 0.4s ease-out;
            }
            button:active:after {
                width: 200%;
                height: 200%;
            }
            .sim {
                position: relative;
                height: 260px;
                margin-top: 0.8rem;
                background: #fafafa;
                border: 2px dashed #c1c6cc;
                border-radius: 8px;
                overflow: hidden;
            }
            .path {
                position: absolute;
                top: 50%;
                height: 2px;
                background: #90a4ae;
                transform: translateY(-50%);
            }
            #vanillaArea .path {
                left: 8%;
                right: 8%;
            }
            #poolArea .path.clientPool {
                left: 8%;
                width: 38%;
            }
            #poolArea .path.poolDb {
                left: 50%;
                width: 42%;
            }
            .label {
                position: absolute;
                top: 6px;
                font-size: 0.75rem;
                color: #455a64;
            }
            #vanillaArea .label.db {
                right: 8%;
            }
            #poolArea .label.client {
                left: 8%;
            }
            #poolArea .label.pool {
                left: 46%;
            }
            #poolArea .label.db {
                right: 8%;
            }
            .ball {
                position: absolute;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: #2196f3;
            }
            .accept {
                background: #4caf50;
            }
            .reject {
                background: #e53935;
            }
            .queue {
                background: #ffb300;
            }
            .counter {
                font-size: 0.95rem;
                margin-top: 0.6rem;
                text-align: center;
            }
            .big {
                font-weight: 600;
                font-size: 1.05rem;
            }
            .legend {
                display: flex;
                gap: 0.8rem;
                justify-content: center;
                margin-top: 0.6rem;
                font-size: 0.8rem;
            }
            .legend span {
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
            }
            .dot {
                width: 14px;
                height: 14px;
                border-radius: 50%;
            }
        </style>
    </head>
    <body>
        <h1>Postgres vs pgBouncer Pooling</h1>

        <div class="grid">
            <!-- Vanilla PG panel -->
            <div class="panel">
                <h2>Without Pooling</h2>
                <label
                    >Postgres max connections
                    <input
                        id="vMax"
                        type="range"
                        min="1"
                        max="40"
                        value="15"
                        oninput="vMaxNum.value=this.value"
                    />
                    <input
                        id="vMaxNum"
                        type="number"
                        min="1"
                        max="40"
                        value="15"
                        oninput="vMax.value=this.value"
                    />
                </label>
                <button id="vBtn">Send request</button>
                <div class="counter">
                    <div class="big">Active: <span id="vActive">0</span></div>
                    <div>
                        Requests: <span id="vTotal">0</span> | Accepted:
                        <span id="vOk">0</span> | Rejected:
                        <span id="vFail">0</span>
                    </div>
                </div>
                <div class="sim" id="vanillaArea">
                    <div class="path"></div>
                    <span class="label db">DB</span>
                </div>
                <div class="legend">
                    <span><span class="dot accept"></span>accepted</span>
                    <span><span class="dot reject"></span>rejected</span>
                </div>
            </div>

            <!-- pgBouncer panel -->
            <div class="panel">
                <h2>With pgBouncer</h2>
                <label
                    >pgBouncer pool size
                    <input
                        id="poolSize"
                        type="range"
                        min="1"
                        max="20"
                        value="8"
                        oninput="poolSizeNum.value=this.value"
                    />
                    <input
                        id="poolSizeNum"
                        type="number"
                        min="1"
                        max="20"
                        value="8"
                        oninput="poolSize.value=this.value"
                    />
                </label>
                <label
                    >Postgres max connections
                    <input
                        id="pMax"
                        type="range"
                        min="1"
                        max="40"
                        value="15"
                        oninput="pMaxNum.value=this.value"
                    />
                    <input
                        id="pMaxNum"
                        type="number"
                        min="1"
                        max="40"
                        value="15"
                        oninput="pMax.value=this.value"
                    />
                </label>
                <button id="pBtn">Send request</button>
                <div class="counter">
                    <div class="big">
                        Active DB: <span id="pDbAct">0</span> | Queued:
                        <span id="pQueued">0</span>
                    </div>
                    <div>
                        Requests: <span id="pTot">0</span> | Completed:
                        <span id="pDone">0</span> | Connections used:
                        <span id="pConn">0</span>
                    </div>
                </div>
                <div class="sim" id="poolArea">
                    <div class="path clientPool"></div>
                    <div class="path poolDb"></div>
                    <span class="label client">Client</span
                    ><span class="label pool">Pool</span
                    ><span class="label db">DB</span>
                </div>
                <div class="legend">
                    <span><span class="dot accept"></span>completed</span>
                    <span><span class="dot queue"></span>queued</span>
                    <span><span class="dot reject"></span>dropped</span>
                </div>
            </div>
        </div>

        <script>
            /* generic helpers */
            function makeBall(area, x, y) {
                const b = document.createElement("div");
                b.className = "ball";
                b.style.left = x + "px";
                b.style.top = y + "px";
                area.appendChild(b);
                return b;
            }
            function moveTo(b, target, dur, cb) {
                const start = parseFloat(b.style.left);
                b.animate([{ left: start + "px" }, { left: target + "px" }], {
                    duration: dur,
                    easing: "linear",
                    fill: "forwards",
                });
                setTimeout(() => {
                    b.style.left = target + "px";
                    cb && cb();
                }, dur);
            }
            /* Vanilla side */
            const vArea = document.getElementById("vanillaArea");
            let vTot = 0,
                vOk = 0,
                vFail = 0,
                vAct = 0;
            const vTotal = document.getElementById("vTotal"),
                vOkEl = document.getElementById("vOk"),
                vFailEl = document.getElementById("vFail"),
                vActEl = document.getElementById("vActive");
            function updateV() {
                vTotal.textContent = vTot;
                vOkEl.textContent = vOk;
                vFailEl.textContent = vFail;
                vActEl.textContent = vAct;
            }
            document.getElementById("vBtn").onclick = () => {
                const max = parseInt(document.getElementById("vMax").value, 10);
                vTot++;
                const b = makeBall(
                    vArea,
                    0,
                    Math.random() * (vArea.clientHeight - 18),
                );
                if (vAct < max) {
                    vAct++;
                    vOk++;
                    b.classList.add("accept");
                    moveTo(b, vArea.clientWidth * 0.84, 500, () =>
                        setTimeout(() => {
                            b.remove();
                            vAct--;
                            updateV();
                        }, 1000),
                    );
                } else {
                    vFail++;
                    b.classList.add("reject");
                    moveTo(b, 60, 350, () =>
                        moveTo(b, 0, 350, () => drop(b, vArea)),
                    );
                }
                updateV();
            };
            function drop(b, area) {
                const final = area.clientHeight - 18,
                    cur = parseFloat(b.style.top);
                b.animate([{ top: cur + "px" }, { top: final + "px" }], {
                    duration: 800,
                    easing: "ease-in",
                    fill: "forwards",
                });
                b.style.top = final + "px";
            }
            updateV();

            /* pgBouncer side */
            const pArea = document.getElementById("poolArea");
            let pTot = 0,
                pDone = 0,
                pQueued = 0,
                pPoolAct = 0,
                pDbAct = 0,
                pConn = 0;
            const queue = [];
            const pTotEl = document.getElementById("pTot"),
                pDoneEl = document.getElementById("pDone"),
                pQueuedEl = document.getElementById("pQueued"),
                pDbActEl = document.getElementById("pDbAct"),
                pConnEl = document.getElementById("pConn");
            function updateP() {
                pTotEl.textContent = pTot;
                pDoneEl.textContent = pDone;
                pQueuedEl.textContent = pQueued;
                pDbActEl.textContent = pDbAct;
                pConnEl.textContent = pConn;
            }
            function enqueue() {
                pTot++;
                const b = makeBall(
                    pArea,
                    0,
                    Math.random() * (pArea.clientHeight - 18),
                );
                b.classList.add("queue");
                queue.push(b);
                pQueued++;
                process();
                updateP();
            }
            function process() {
                const size = parseInt(
                        document.getElementById("poolSize").value,
                        10,
                    ),
                    max = parseInt(document.getElementById("pMax").value, 10),
                    poolX = pArea.clientWidth * 0.38,
                    dbX = pArea.clientWidth * 0.76;
                while (queue.length && pPoolAct < size && pDbAct < max) {
                    const b = queue.shift();
                    pQueued--;
                    pPoolAct++;
                    pDbAct++;
                    if (pDbAct > pConn) pConn = pDbAct;
                    b.classList.remove("queue");
                    b.classList.add("accept");
                    moveTo(b, poolX, 300, () =>
                        moveTo(b, dbX, 400, () => {
                            setTimeout(() => {
                                pDbAct--;
                                pPoolAct--;
                                pDone++;
                                b.remove();
                                process();
                                updateP();
                            }, 1000);
                        }),
                    );
                }
            }
            document.getElementById("pBtn").onclick = enqueue;
            updateP();
        </script>
    </body>
</html>
